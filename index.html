<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ESCAPE THE UPSIDE DOWN - Hawkins Lab Simulation</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Primary Meta Tags -->
    <meta name="title" content="ESCAPE THE UPSIDE DOWN - Hawkins Lab Simulation">
    <meta name="description" content="Run for your life through the Upside Down! A Stranger Things-inspired endless runner game. Can you escape the Mind Flayer?">

    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="ESCAPE THE UPSIDE DOWN">
    <meta property="og:description" content="Run for your life through the Upside Down! A Stranger Things-inspired endless runner game. Can you escape the Mind Flayer?">
    <meta property="og:image" content="/og-image.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="ESCAPE THE UPSIDE DOWN">
    <meta property="twitter:description" content="Run for your life through the Upside Down! A Stranger Things-inspired endless runner game.">
    <meta property="twitter:image" content="/og-image.png">
    <style>
        /* Merriweather (Benguiat-ish), Audiowide (Tech), Share Tech Mono (Code) */
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@900&family=Audiowide&family=Share+Tech+Mono&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #050000;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Merriweather', serif;
            transition: background-color 0.5s ease;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated; /* <--- ADD THIS LINE HERE */
        }

        /* UPSIDE DOWN ATMOSPHERE */
        #scanlines {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: 
                radial-gradient(circle, rgba(0,0,0,0) 40%, rgba(20, 0, 0, 0.9) 100%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
            z-index: 50;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* UI LAYER */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 100;
        }

        @supports (padding-top: env(safe-area-inset-top)) {
            #ui-layer {
                padding-top: max(20px, env(safe-area-inset-top));
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        .controls-top-right {
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        .icon-btn {
            background: rgba(30, 0, 0, 0.8);
            border: 2px solid #ff0000;
            color: #ff0000;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        .icon-btn:hover {
            background: #ff0000;
            color: #000;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .score-box {
            background: rgba(10, 0, 0, 0.9);
            padding: 10px 20px;
            border: 2px solid #ff0000;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
            backdrop-filter: blur(4px);
        }

        .label {
            color: #ff0000; font-family: 'Share Tech Mono', monospace; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; font-weight: bold;
        }

        .value {
            color: #fff; font-family: 'Audiowide', cursive; font-size: 24px; text-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
        }

        .value.high { color: #fff; text-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }

        /* SCREENS */
        .screen {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: auto;
            transition: opacity 0.4s ease, transform 0.4s ease;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 120;
            width: 90%; max-width: 800px; /* Increased max width */
            max-height: 95vh;
            overflow-y: auto;
            scrollbar-width: none;
            padding: 20px 0; /* Add padding to prevent clipping */
        }
        .screen::-webkit-scrollbar { display: none; }

        .screen.hidden { opacity: 0; pointer-events: none; transform: translate(-50%, -45%); }

        /* STRANGER THINGS TITLE STYLE - MASTERPIECE */
        h1 {
            font-family: 'Merriweather', serif;
            font-weight: 900;
            font-size: 3.5rem; /* Default mobile size */
            color: transparent;
            background-image: 
                radial-gradient(circle at 30% 30%, #ff3333 10%, transparent 10%),
                radial-gradient(circle at 70% 70%, #990000 10%, transparent 10%),
                repeating-linear-gradient(45deg, #ff0000, #ff0000 5px, #550000 5px, #550000 10px);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-stroke: 1.5px #ff0000;
            margin: 0 0 20px 0;
            line-height: 1.2; /* Increased line height */
            text-transform: uppercase;
            letter-spacing: -1px; /* Relaxed letter spacing slightly */
            filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
            animation: titleGlow 4s infinite alternate;
            position: relative;
            word-wrap: break-word; /* Ensure long words wrap */
            width: 100%; /* Take full width */
        }

        h1::after {
            content: ""; display: block; width: 100%; height: 3px; background: #ff0000;
            box-shadow: 0 0 15px #ff0000; margin-top: 5px; border-radius: 50%;
        }
        
        h1::before {
            content: ""; display: block; width: 100%; height: 3px; background: #ff0000;
            box-shadow: 0 0 15px #ff0000; margin-bottom: 5px; border-radius: 50%;
        }

        @keyframes titleGlow {
            0% { filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.5)); transform: scale(1); }
            100% { filter: drop-shadow(0 0 25px rgba(255, 0, 0, 1)); transform: scale(1.02); }
        }

        .subtitle {
            font-family: 'Audiowide', cursive;
            font-size: 1rem; color: #fff; letter-spacing: 6px; margin-bottom: 30px; margin-top: 15px;
            text-transform: uppercase; text-shadow: 0 0 10px #fff; 
            width: 100%; text-align: center;
        }

        .btn-neon {
            background: rgba(0, 0, 0, 0.85);
            color: #ff0000;
            font-family: 'Merriweather', serif;
            font-weight: 900;
            font-size: 24px;
            padding: 18px 60px;
            border: 3px solid #ff0000;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.5), inset 0 0 15px rgba(255, 0, 0, 0.2);
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            min-width: 250px;
        }

        .btn-neon:hover {
            background: #ff0000;
            color: #000;
            box-shadow: 0 0 60px rgba(255, 0, 0, 1);
            transform: scale(1.05);
            text-shadow: none;
        }

        .controls-hint {
            display: flex; gap: 30px; margin-top: 40px; font-size: 12px; color: #aaa;
            text-transform: uppercase; justify-content: center; width: 100%; font-family: 'Audiowide', cursive;
        }
        .controls-hint span { color: #ff0000; font-weight: bold; display: block; font-size: 16px; margin-bottom: 4px; text-shadow: 0 0 5px #ff0000; }

        /* LEADERBOARD */
        .leaderboard-container {
            margin-top: 25px; background: rgba(0, 0, 0, 0.95); border: 2px solid #333;
            padding: 15px; width: 100%; max-width: 320px;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.15);
            border-top: 4px solid #ff0000;
            display: block !important;
        }

        .lb-title {
            color: #ff0000; font-family: 'Merriweather', serif; font-weight: 900;
            font-size: 16px; letter-spacing: 1px; margin-bottom: 15px;
            text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 8px;
            display: flex; justify-content: space-between;
        }

        .lb-row {
            display: flex; justify-content: space-between; color: #aaa;
            font-size: 14px; margin-bottom: 8px; font-family: 'Share Tech Mono', monospace;
        }
        .lb-row:first-child { color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.6); font-weight: bold; }

        /* INPUTS */
        #player-name-start {
            background: transparent; border: none; border-bottom: 3px solid #ff0000;
            color: #fff; font-family: 'Merriweather', serif; font-weight: 900; font-size: 40px;
            text-align: center; width: 80%; max-width: 350px; outline: none;
            margin-bottom: 30px; text-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            text-transform: uppercase;
        }
        #player-name-start::placeholder { color: rgba(255, 0, 0, 0.3); font-family: 'Audiowide', cursive; font-size: 20px; text-shadow: none; }

        #player-name-input {
            background: transparent; border: none; border-bottom: 2px solid #ff0000;
            color: #fff; font-family: 'Merriweather', serif; font-size: 28px;
            text-align: center; width: 200px; outline: none; margin-bottom: 10px; text-transform: uppercase;
        }

        .name-input-container { margin-top: 20px; display: flex; flex-direction: column; align-items: center; }

        /* AI LOG (Fixed Z-Index to show ON TOP of everything) */
        #ai-toast {
            position: absolute; 
            top: 15%; 
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(10, 0, 0, 0.95); 
            border: 2px solid #ff0000; 
            color: #fff;
            padding: 15px 25px; 
            border-radius: 4px; 
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px; 
            text-align: center; 
            opacity: 0; 
            transition: opacity 0.5s ease;
            max-width: 80%; 
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
            pointer-events: none; 
            z-index: 200; /* Higher than any screen */
        }
        #ai-toast.visible { opacity: 1; }
        #ai-toast span { color: #ff0000; font-weight: bold; display: block; margin-bottom: 5px; font-size: 12px; letter-spacing: 2px; }

        #mission-log {
            font-family: 'Share Tech Mono', monospace; color: #ff0000; font-size: 15px;
            margin: 15px 0; width: 90%; max-width: 450px; min-height: 40px;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6); white-space: pre-wrap; line-height: 1.5;
            background: rgba(10, 0, 0, 0.9); padding: 15px; border: 1px solid rgba(255, 0, 0, 0.4);
            border-radius: 4px; display: none; text-align: left;
        }
        #mission-log.visible { display: block; animation: fadeIn 0.5s ease; }

        .score-comparison {
            font-family: 'Share Tech Mono', monospace; color: #aaa; font-size: 14px;
            margin-top: 10px; letter-spacing: 1px;
        }
        .score-comparison span { color: #fff; font-weight: bold; }
        .score-comparison span.gap { color: #ff0000; font-size: 16px; }

        /* PAUSE SCREEN */
        #pause-screen {
            background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
        }
        
        /* DIFFICULTY BUTTONS */
        .diff-container {
            display: flex; 
            gap: 20px; 
            margin-bottom: 20px;
            flex-direction: column;
            width: 100%;
            align-items: center;
        }
        
        .btn-diff {
            font-size: 20px; 
            padding: 15px 40px;
            width: 280px;
            text-align: center;
            background: rgba(10, 0, 0, 0.9);
        }

        /* LIGHT MODE OVERRIDES */
        body.light-mode { background-color: #ffecf9; }
        body.light-mode #scanlines { opacity: 0.05; background: #fff; }
        body.light-mode h1 { 
            color: #ff0099; -webkit-text-stroke: 2px #00e5ff; background-image: none;
            background-clip: unset; -webkit-background-clip: unset; text-shadow: 5px 5px 0px #ffe600;
        }
        body.light-mode h1::after { background: #00e5ff; box-shadow: 0 0 10px #00e5ff; }
        body.light-mode h1::before { background: #00e5ff; box-shadow: 0 0 10px #00e5ff; }
        body.light-mode .subtitle { color: #5e17eb; text-shadow: none; border-top-color: #333; }
        
        body.light-mode .btn-neon { 
            border: 3px solid #ff0099; color: #ff0099; background: rgba(255,255,255,0.9);
            box-shadow: 5px 5px 0px rgba(0,229,255,0.5); text-shadow: none; animation: none; 
        }
        body.light-mode .btn-neon:hover { background: #ff0099; color: #fff; box-shadow: 5px 5px 15px rgba(0,229,255,0.8); }
        
        body.light-mode .score-box { background: rgba(255,255,255,0.95); border: 2px solid #00e5ff; color: #333; box-shadow: 5px 5px 0px #ff0099; }
        body.light-mode .label { color: #ff0099; font-weight: 900; }
        body.light-mode .value { color: #333; text-shadow: none; font-weight: 900; }
        body.light-mode .icon-btn { background: #fff; color: #ff0099; border: 2px solid #00e5ff; box-shadow: 3px 3px 0px #ff0099; }
        body.light-mode .icon-btn:hover { background: #ff0099; color: #fff; }
        body.light-mode .leaderboard-container { background: #fff; border: 3px solid #00e5ff; border-top: 6px solid #ff0099; color: #000; box-shadow: 10px 10px 0px rgba(255,0,153,0.2); }
        body.light-mode .lb-title { color: #ff0099; border-bottom: 2px solid #eee; }
        body.light-mode .lb-row { color: #555; }
        body.light-mode .lb-row:first-child { color: #00e5ff; text-shadow: none; font-weight: bold; }
        body.light-mode #player-name-start { border-bottom-color: #ff0099; color: #333; text-shadow: 2px 2px 0px #00e5ff; font-weight: 900; }
        body.light-mode .controls-hint { color: #555; }
        body.light-mode .controls-hint span { color: #ff0099; text-shadow: none; }

        @media (min-width: 768px) {
            h1 { font-size: 5rem; margin-bottom: 30px; } /* Adjusted desktop size */
            .value { font-size: 32px; }
            .screen { max-width: 800px; }
            #player-name-start { font-size: 56px; }
        }
        @media (max-height: 600px) and (orientation: landscape) {
            h1 { font-size: 2.5rem; margin-bottom: 5px; } /* Smaller for landscape mobile */
            h1::after { display: none; } 
            h1::before { display: none; }
            .subtitle { margin-bottom: 10px; }
            .screen { top: 50%; }
            .leaderboard-container { display: none; } 
            #ui-layer { padding: 10px; }
            .btn-neon { padding: 10px 30px; font-size: 18px; margin-top: 10px; }
        }
        
        /* Mobile specific adjustment to ensure full width usage */
        @media (max-width: 480px) {
             h1 { font-size: 2.8rem; letter-spacing: -1px; }
             .screen { width: 95%; }
        }
    </style>
</head>
<body class="dark-mode">

    <div id="scanlines"></div>
    <div id="ai-toast"><span>INCOMING TRANSMISSION</span><div id="ai-toast-msg">Synchronizing...</div></div>
    
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        
        <div class="hud-top">
            <div class="score-box">
                <div class="label">Distance</div>
                <div class="value" id="score">00000</div>
            </div>
            
            <div class="controls-top-right">
                <div class="score-box" style="margin-right: 15px;">
                    <div class="label">Top Survivor</div>
                    <div class="value high" id="hud-highscore">LOADING</div>
                </div>
                <div class="icon-btn" onclick="window.toggleTheme()" title="Flip Dimensions">
                    <span>☀</span>
                </div>
                <div class="icon-btn" onclick="window.togglePause()" title="Pause">
                    <span>⏸</span>
                </div>
            </div>
        </div>
    </div>

    <!-- TITLE SCREEN -->
    <div id="start-screen" class="screen">
        <h1 data-text="ESCAPE THE UPSIDE DOWN">ESCAPE THE UPSIDE DOWN</h1>
        <div class="subtitle">HAWKINS LAB SIMULATION by Abhiram R Ajay</div>
        
        <button class="btn-neon" onclick="window.goToNameEntry()">ENTER THE VOID</button>
        <button id="btn-predict" class="btn-neon" onclick="window.predictFate()" style="margin-top: 15px; font-size: 14px; padding: 10px 25px; border-color: #00f2ff; color: #00f2ff; border-width: 2px;">PREDICT FATE ✨</button>
        
        <div class="leaderboard-container">
            <div class="lb-title"><span>Survivors</span> <span id="lb-status" style="font-size:10px; opacity:0.5;">...</span></div>
            <div id="leaderboard-list">
                <div class="lb-row" style="justify-content: center;"><span>SEARCHING FREQUENCY...</span></div>
            </div>
        </div>

        <div class="controls-hint">
            <div><span>TAP</span> JUMP</div>
            <div><span>SWIPE DOWN</span> DIVE</div>
        </div>
    </div>

    <!-- PAUSE SCREEN -->
    <div id="pause-screen" class="screen hidden">
        <h1 style="font-size: 5rem; -webkit-text-stroke: 0; color: #fff; text-shadow: 0 0 20px #fff; background: none; -webkit-background-clip: unset;">FROZEN</h1>
        <div class="subtitle">TIME STOPPED IN THE VOID</div>
        <button class="btn-neon" onclick="window.togglePause()">RESUME</button>
        <button class="btn-neon" onclick="window.consultCerebro()" style="margin-top: 15px; border-color: #00f2ff; color: #00f2ff;">CEREBRO UPLINK ✨</button>
    </div>

    <!-- NAME ENTRY SCREEN -->
    <div id="name-entry-screen" class="screen hidden">
        <h1 style="font-size: 3rem; -webkit-text-stroke: 1px #ff0000;">IDENTITY</h1>
        <div class="subtitle" style="margin-bottom: 20px; font-size: 14px; opacity: 0.7;">WHO ARE YOU?</div>
        
        <input type="text" id="player-name-start" maxlength="15" placeholder="NAME..." autocomplete="off">
        
        <button class="btn-neon" onclick="window.completeStart()">CONTINUE</button>
    </div>

    <!-- DIFFICULTY SCREEN -->
    <div id="difficulty-screen" class="screen hidden">
        <h1 style="font-size: 3rem; -webkit-text-stroke: 1px #ff0000;">FATE</h1>
        <div class="subtitle" style="margin-bottom: 30px;">CHOOSE YOUR PATH</div>
        
        <div class="diff-container">
            <button class="btn-neon btn-diff" onclick="window.startGame('easy')">EASY</button>
            <button class="btn-neon btn-diff" onclick="window.startGame('medium')">MEDIUM</button>
            <button class="btn-neon btn-diff" onclick="window.startGame('hard')">HARD</button>
        </div>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="game-over-screen" class="screen hidden">
        <h1 style="font-size: 5rem; -webkit-text-stroke: 0; color: #ff0000; text-shadow: 0 0 40px #ff0000; background: none; -webkit-background-clip: unset;">FLAYED</h1>
        <div class="subtitle" style="color: #fff; text-shadow: none; opacity: 0.8;">THE MIND FLAYER CAUGHT YOU</div>
        
        <div class="score-comparison" id="score-comparison-text">CALCULATING...</div>

        <div id="mission-log"></div>

        <button id="btn-analyze" class="btn-neon" onclick="window.analyzeRun()" style="border-color: #fff; color: #fff; font-size: 14px; padding: 12px 30px; margin-bottom: 20px; box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);">ASK THE ENTITY ✨</button>

        <div id="new-record-ui" class="hidden name-input-container">
            <div style="color: #fff; margin-bottom: 10px; font-family: 'Share Tech Mono';">NEW SURVIVOR RECORD!</div>
            <input type="text" id="player-name-input" maxlength="10" placeholder="___">
            <button class="btn-neon" onclick="window.saveScoreAndRestart()" style="margin-top: 10px; padding: 10px 30px;">SAVE SOUL</button>
        </div>

        <div id="restart-btn-container">
            <button class="btn-neon" onclick="window.resetGame()">ESCAPE AGAIN</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UTILS & CONSTANTS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const apiKey = typeof "" !== 'undefined' ? "" : "";
        function random(min, max) { return Math.random() * (max - min) + min; }

        // --- THEMES ---
        const THEMES = {
            dark: { // THE UPSIDE DOWN
                bg: '#050000',
                grid: '#880000', // Blood Red
                sunTop: '#ff0000', // Red Sun
                sunBot: '#220000',
                player: '#fff', // Pure white (Eleven/Energy)
                playerCore: '#ff0000',
                obstacle: '#550000', // Flesh/Dark
                mountains1: '#1a0000', // Silhouette
                mountains2: '#2a0000',
                particleFire: '#ff0000',
                particleDebris: '#550000',
                particleDust: '#888' // Spores
            },
            light: { // STARCOURT MALL (80s Vibrant)
                bg: '#ffe6f2',
                grid: '#00e5ff', 
                sunTop: '#ff0099', 
                sunBot: '#ffea00', 
                player: '#333', 
                playerCore: '#00e5ff',
                obstacle: '#111', 
                mountains1: '#999', 
                mountains2: '#bbb', 
                particleFire: '#333', 
                particleDebris: '#555',
                particleDust: '#888'
            }
        };

        const DIFFICULTY_SETTINGS = {
            // Easy: Starts slow but scales to high speed (60)
            easy: { baseSpeed: 9, maxSpeed: 60, accel: 0.008, gapMult: 24, types: ['spike', 'drone'] },
            // Medium: Very fast acceleration, high cap (90)
            medium: { baseSpeed: 12, maxSpeed: 90, accel: 0.015, gapMult: 18, types: ['spike', 'drone', 'demodog'] },
            // Hard: Insane start (16), basically unlimited speed (130)
            hard: { baseSpeed: 16, maxSpeed: 130, accel: 0.025, gapMult: 13, types: ['spike', 'drone', 'demodog', 'demogorgon'] }
        };

        let currentTheme = 'dark';
        let currentDiff = 'easy'; // Default
        
        let CONFIG = {
            gravity: 1.5,      
            jumpForce: -22,    
            groundHeight: 0, 
            baseSpeed: 10,     
            maxSpeed: 50, 
            acceleration: 0.005, 
            colors: THEMES.dark,
            settings: DIFFICULTY_SETTINGS.easy // Added default settings
        };

        // --- GLOBAL STATE ---
        let width = window.innerWidth;
        let height = window.innerHeight;
        let gameActive = false;
        let isPaused = false;
        let frame = 0;
        let score = 0;
        let shake = 0;
        let currentPlayerName = "PILOT";
        let loopId;
        let globalTopScore = 0;
        let keys = { up: false, down: false };
        let touchStartY = 0;
        let gameSpeed = CONFIG.baseSpeed;
        let nextSpawnGap = 0; 
        let deathCause = "unknown"; 

        // Entities
        let player = null;
        let obstacles = [];
        let particles = [];
        let bg = null;

        // --- FIREBASE SETUP ---
        let db, auth, user, appId;
        let useLocalStorage = false;

        async function initFirebase() {
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    
                    onAuthStateChanged(auth, (u) => {
                        user = u;
                        if (user) refreshLeaderboard();
                    });

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    throw new Error("Missing config");
                }
            } catch (e) {
                console.warn("Offline Mode Active:", e);
                enableOfflineMode();
            }
        }

        function enableOfflineMode() {
            useLocalStorage = true;
            const lbStatus = document.getElementById('lb-status');
            if (lbStatus) lbStatus.innerText = "LOCAL";
            refreshLeaderboard();
        }

        // --- AUDIO ---
        class SoundSynth {
            constructor() {
                this.ctx = null; this.isPlayingMusic = false; this.musicInterval = null; this.musicNoteIndex = 0;
                // Stranger Things Pattern Cmaj7
                this.arp = [130.81, 164.81, 196.00, 246.94, 261.63, 246.94, 196.00, 164.81];
                this.bassFreq = 32.70;
            }
            init() { if (!this.ctx) { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } if (this.ctx.state === 'suspended') { this.ctx.resume(); } }
            playTone(freq, type, duration, vol = 0.1, slideTo = null) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                if (slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, this.ctx.currentTime + duration);
                gain.gain.setValueAtTime(0.001, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + duration);
            }
            playJump() { this.playTone(200, 'square', 0.2, 0.1, 600); }
            playExplosion() {
                if (!this.ctx) return;
                const bufferSize = this.ctx.sampleRate * 1.5; const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 800;
                const gain = this.ctx.createGain(); gain.gain.setValueAtTime(0.5, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 1.5);
                noise.connect(filter); filter.connect(gain); gain.connect(this.ctx.destination); noise.start();
                this.playTone(50, 'sawtooth', 0.8, 0.3, 10);
            }

            // CREEL CLOCK CHIME
            playCreelClock() {
                if (!this.ctx) return;
                const now = this.ctx.currentTime;
                // Clock Bell Fundamental (Deep C# roughly)
                const freq = 140; 
                // Additive Synthesis for metallic bell sound
                const partials = [1, 2.05, 3.1, 4.2]; // Inharmonic
                
                partials.forEach((p, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = i === 0 ? 'sine' : 'triangle';
                    osc.frequency.setValueAtTime(freq * p, now);
                    
                    // Heavy impact, long decay
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.5 / (i + 1), now + 0.05); // Attack
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 4.0); // 4 second decay
                    
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now);
                    osc.stop(now + 4.5);
                });
            }

            startMusic() {
                if (this.isPlayingMusic) return; this.init(); this.isPlayingMusic = true; this.musicNoteIndex = 0;
                this.musicInterval = setInterval(() => {
                    if (!this.isPlayingMusic) return;
                    if (isPaused) return;
                    const beat = this.musicNoteIndex % 8;
                    this.playTone(this.arp[beat] * 2, 'sawtooth', 0.3, 0.05);
                    if (beat === 0 || beat === 4) {
                        this.playTone(this.bassFreq, 'square', 0.4, 0.15); 
                        this.playTone(100, 'sine', 0.1, 0.4, 0.01);
                    }
                    this.musicNoteIndex++;
                }, 180);
            }
            stopMusic() { this.isPlayingMusic = false; clearInterval(this.musicInterval); }
        }
        const sfx = new SoundSynth();

        // --- GEMINI AI ---
        async function callGemini(prompt) {
            // Safety check for empty key
            if (!apiKey) throw new Error("No API Key");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error`);
            const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text || "No data.";
        }

        window.generatePilotIdentity = async function(name) {
            const toast = document.getElementById('ai-toast');
            const toastMsg = document.getElementById('ai-toast-msg');
            
            // Fallback for no API Key
            if (!apiKey) {
                toast.classList.add('visible');
                toastMsg.innerText = `Subject: ${name.toUpperCase()} // STATUS: ROGUE`;
                setTimeout(() => { toast.classList.remove('visible'); }, 3000);
                return;
            }

            const prompt = `Generate a cool, 5-word cyberpunk title/rank for a racer named ${name}. No quotes.`;
            try {
                toast.classList.add('visible');
                toastMsg.innerText = "Analyzing Neural Profile...";
                const response = await callGemini(prompt);
                toastMsg.innerText = response;
                setTimeout(() => { toast.classList.remove('visible'); }, 4000);
            } catch (e) { console.log("AI inactive"); }
        }
        
        // Feature 1: Predict Fate (Start Screen)
        window.predictFate = async function() {
            const toast = document.getElementById('ai-toast');
            const toastMsg = document.getElementById('ai-toast-msg');
            toast.classList.add('visible');
            toastMsg.innerText = "Consulting the Void...";

            // Fallback for no API Key
            if (!apiKey) {
                setTimeout(() => {
                    const fates = [
                        "THE MIND FLAYER SEES YOU.",
                        "YOU CANNOT RUN FOREVER.",
                        "THE GATE IS OPENING.",
                        "DARKNESS CONSUMES ALL.",
                        "FRIENDS DON'T LIE, YOU DIE."
                    ];
                    toastMsg.innerText = fates[Math.floor(Math.random() * fates.length)];
                    setTimeout(() => { toast.classList.remove('visible'); }, 4000);
                }, 1000);
                return;
            }

            const prompt = "Predict a grim, sci-fi/horror demise for a runner in the Upside Down. Max 10 words. Cryptic tone.";
            try {
                const response = await callGemini(prompt);
                toastMsg.innerText = response;
                setTimeout(() => { toast.classList.remove('visible'); }, 5000);
            } catch(e) { 
                toastMsg.innerText = "THE VOID IS SILENT.";
                setTimeout(() => { toast.classList.remove('visible'); }, 3000);
            }
        }

        // Feature 2: Cerebro Uplink (Pause Screen)
        window.consultCerebro = async function() {
            const toast = document.getElementById('ai-toast');
            const toastMsg = document.getElementById('ai-toast-msg');
            toast.classList.add('visible');
            toastMsg.innerText = "Tuning Radio...";

            // Fallback for no API Key
            if (!apiKey) {
                setTimeout(() => {
                    const msgs = [
                        "DUSTIN: Code Red! Do you copy?!",
                        "LUCAS: It's right behind you!",
                        "HOPPER: Kid, get out of there!",
                        "SUZIE: Planck's Constant is 6.62607004!",
                        "JOYCE: WHERE IS MY BOY?!"
                    ];
                    toastMsg.innerText = msgs[Math.floor(Math.random() * msgs.length)];
                    setTimeout(() => { toast.classList.remove('visible'); }, 4000);
                }, 1000);
                return;
            }

            const prompt = "Roleplay as Dustin Henderson from Stranger Things. Provide a frantic, 1-sentence radio warning about monsters nearby. Use slang like 'Code Red'.";
            try {
                const response = await callGemini(prompt);
                toastMsg.innerText = "DUSTIN: " + response;
                setTimeout(() => { toast.classList.remove('visible'); }, 6000);
            } catch(e) { 
                toastMsg.innerText = "STATIC NOISE...";
                setTimeout(() => { toast.classList.remove('visible'); }, 3000);
            }
        }

        window.analyzeRun = async function() {
            const btn = document.getElementById('btn-analyze'); const log = document.getElementById('mission-log');
            btn.innerText = "DECRYPTING..."; btn.disabled = true; log.classList.add('visible'); log.innerText = "Scanning telemetry...";
            
            // Fallback for no API Key
            if (!apiKey) { 
                setTimeout(() => { 
                    log.innerText = `DATA LOG:\n> STATUS: TERMINATED\n> CAUSE: THE MIND FLAYER\n> SUGGESTION: RUN FASTER.`; 
                    btn.style.display = 'none'; 
                }, 1500); 
                return; 
            }

            const finalScore = Math.floor(score);
            let context = "";
            if (deathCause === 'drone') context = "Devoured by a Demobat swarm.";
            else if (deathCause === 'spike') context = "Entangled in the Hive Mind vines.";
            else if (deathCause === 'demodog') context = "Mauled by a Demodog pack.";
            else if (deathCause === 'demogorgon') context = "Face opened by the Demogorgon.";
            const prompt = `You are a cryptic, horror narrator from the Upside Down (Stranger Things style). The runner died at ${finalScore}m. Speed was ${Math.floor(gameSpeed * 10)} km/h. Cause: ${context}. High score is ${globalTopScore}m. Give a 1 sentence chilling, dark reason why they failed.`;
            try { const responseText = await callGemini(prompt); log.innerText = responseText; btn.style.display = 'none'; } 
            catch (error) { log.innerText = "CONNECTION ERROR: SIGNAL LOST IN THE VOID."; btn.innerText = "RETRY"; btn.disabled = false; }
        }

        // --- CLASSES ---
        class Particle {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; this.life = 1.0;
                if (type === 'dust') { 
                    this.vx = -gameSpeed + (random(0,2) -1); 
                    this.vy = random(0, -1.5) -0.5; 
                    this.decay = 0.05; 
                    this.color = CONFIG.colors.particleDust; 
                    this.size = random(2, 4); 
                } 
                else if (type === 'spark') { 
                    this.vx = (random(0, 10) - 5); 
                    this.vy = (random(0, 10) - 5); 
                    this.decay = 0.03; 
                    this.color = '#fff'; 
                    this.size = random(1, 3); 
                } 
                else if (type === 'debris') { 
                    this.vx = (random(0, 15) - 7.5); 
                    this.vy = (random(0, -15) - 5); 
                    this.decay = 0.015; 
                    this.color = CONFIG.colors.particleDebris; 
                    this.size = random(3, 8); 
                } 
                else if (type === 'fire') { 
                    this.vx = (random(0, 6) - 3); 
                    this.vy = (random(0, -8) - 2); 
                    this.decay = 0.04; 
                    this.color = CONFIG.colors.particleFire; 
                    this.size = random(4, 12); 
                }
            }
            update() {
                this.x += this.vx; this.y += this.vy; this.life -= this.decay;
                if (this.type === 'debris' || this.type === 'spark') this.vy += 0.5; 
                if (this.type === 'debris' && this.y > height - CONFIG.groundHeight) { this.y = height - CONFIG.groundHeight; this.vy *= -0.6; }
            }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color;
                if (currentTheme === 'dark' && this.type === 'dust') ctx.fillStyle = 'rgba(255,255,255,0.3)'; // Ash/Spores
                if (currentTheme === 'dark' && (this.type === 'fire' || this.type === 'spark')) { 
                    ctx.shadowBlur = 10; ctx.shadowColor = this.color; 
                }
                ctx.fillRect(this.x, this.y, this.size, this.size); ctx.shadowBlur = 0; ctx.globalAlpha = 1;
            }
        }

        class Player {
            constructor() {
                this.w = 60; this.h = 30; this.x = 80;
                this.y = height - CONFIG.groundHeight - this.h;
                this.vy = 0; this.isGrounded = true; this.visible = true;
                this.stretch = 0; this.trail = []; this.rotation = 0; this.enginePulse = 0;
            }
            jump() {
                if (this.isGrounded && this.visible) {
                    this.vy = CONFIG.jumpForce; 
                    this.isGrounded = false; 
                    this.stretch = 0.4; 
                    sfx.playJump();
                    for(let i=0; i<8; i++) particles.push(new Particle(this.x + 10, this.y + this.h, 'dust'));
                }
            }
            dive() { if (!this.isGrounded && this.visible) this.vy += 3.0; } 
            update() {
                if (!this.visible) return;
                
                // Variable Jump Height Logic
                if (this.vy < 0 && !keys.up) {
                    this.vy += CONFIG.gravity * 3.5; 
                }

                this.vy += CONFIG.gravity; 
                this.y += this.vy; 
                this.stretch *= 0.8; 
                this.enginePulse += 0.5;

                if (this.y + this.h > height - CONFIG.groundHeight) {
                    if (!this.isGrounded) {
                        this.stretch = -0.5;
                        for(let i=0; i<8; i++) particles.push(new Particle(this.x + this.w/2, this.y + this.h, 'dust'));
                        if (this.vy > 25) shake = 8;
                    }
                    this.y = height - CONFIG.groundHeight - this.h; this.vy = 0; this.isGrounded = true; this.rotation = 0;
                } else {
                    if (this.vy < 0) this.rotation = -0.15; else this.rotation += 0.05 * (gameSpeed / 12);
                }
                if (frame % 2 === 0) { this.trail.push({x: this.x, y: this.y, rot: this.rotation, alpha: 0.6}); if (this.trail.length > 8) this.trail.shift(); }
            }
            explode() {
                this.visible = false;
                for(let k=0; k<25; k++) particles.push(new Particle(this.x + this.w/2, this.y + this.h/2, 'fire'));
                for(let k=0; k<40; k++) particles.push(new Particle(this.x + this.w/2, this.y + this.h/2, 'debris'));
                for(let k=0; k<30; k++) particles.push(new Particle(this.x + this.w/2, this.y + this.h/2, 'spark'));
            }

            getHitbox() {
                return {
                    x: this.x + 12,
                    y: this.y + 8,
                    w: this.w - 24,
                    h: this.h - 16
                };
            }

            draw() {
                if (!this.visible) return;
                
                // Trail
                if (currentTheme === 'dark') ctx.globalCompositeOperation = 'lighter';
                this.trail.forEach(t => {
                    t.x -= gameSpeed; t.alpha -= 0.05;
                    ctx.save(); ctx.translate(t.x + this.w/2, t.y + this.h/2); ctx.rotate(t.rot);
                    ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0, t.alpha)})`; // White/Blue trail
                    if (currentTheme === 'light') ctx.fillStyle = `rgba(0, 0, 0, ${Math.max(0, t.alpha * 0.2)})`; 
                    ctx.beginPath(); ctx.moveTo(-this.w/2, 0); ctx.lineTo(this.w/2, 0); ctx.lineTo(this.w/2 - 10, this.h/2); ctx.lineTo(-this.w/2 + 5, this.h/2); ctx.fill(); ctx.restore();
                });
                ctx.globalCompositeOperation = 'source-over';

                ctx.save(); ctx.translate(this.x + this.w/2, this.y + this.h);
                ctx.scale(1 - this.stretch * 0.5, 1 + this.stretch); ctx.translate(-(this.x + this.w/2), -(this.y + this.h));
                ctx.translate(this.x + this.w/2, this.y + this.h/2); ctx.rotate(this.rotation);

                // --- RETRO BLAZER (HOPPER STYLE) ---
                
                // 1. Engine / Tail Lights
                if (currentTheme === 'dark') ctx.globalCompositeOperation = 'lighter';
                ctx.shadowBlur = currentTheme === 'dark' ? (20 + Math.sin(this.enginePulse)*10) : 0;
                ctx.shadowColor = '#ff0000'; ctx.fillStyle = '#ff0000';
                if (currentTheme === 'light') ctx.fillStyle = '#ff4e50'; 
                ctx.beginPath(); ctx.rect(-this.w/2, 0, 5, 10); ctx.fill(); // Left light
                ctx.globalCompositeOperation = 'source-over';

                // 2. Body (Boxy 80s SUV Shape)
                ctx.shadowBlur = currentTheme === 'dark' ? 15 : 0;
                ctx.shadowColor = CONFIG.colors.player;
                
                if (currentTheme === 'light') {
                    ctx.fillStyle = '#888';
                } else {
                    ctx.fillStyle = '#050505';
                }
                
                ctx.strokeStyle = CONFIG.colors.player; ctx.lineWidth = 2;
                ctx.beginPath(); 
                ctx.moveTo(-this.w/2, 0); 
                ctx.lineTo(this.w/2, 0); // Hood
                ctx.lineTo(this.w/2, this.h/2); // Front
                ctx.lineTo(-this.w/2 + 5, this.h/2); // Bottom
                ctx.lineTo(-this.w/2, 0); // Back
                ctx.closePath(); ctx.fill(); ctx.stroke();

                // 3. Cabin / Roof
                ctx.shadowBlur = currentTheme === 'dark' ? 10 : 0;
                ctx.shadowColor = '#fff'; 
                ctx.fillStyle = '#fff'; // Windows
                ctx.beginPath(); 
                ctx.moveTo(-this.w/2 + 10, 0);
                ctx.lineTo(this.w/2 - 15, 0);
                ctx.lineTo(this.w/2 - 20, -10); // Windshield
                ctx.lineTo(-this.w/2 + 15, -10); // Roof
                ctx.closePath();
                ctx.fill();
                
                // Beacon (Police Light)
                ctx.fillStyle = frame % 20 < 10 ? '#ff0000' : '#0000ff'; // Flashing
                ctx.fillRect(0, -14, 6, 4);

                // 4. Wheels
                ctx.strokeStyle = CONFIG.colors.player; ctx.lineWidth = 1; 
                ctx.beginPath(); 
                let wheelR = 8;
                // Rear Wheel
                ctx.arc(-this.w/2 + 15, this.h/2, wheelR, 0, Math.PI*2);
                // Front Wheel
                ctx.moveTo(this.w/2 - 15 + wheelR, this.h/2);
                ctx.arc(this.w/2 - 15, this.h/2, wheelR, 0, Math.PI*2);
                ctx.stroke();

                ctx.restore();
            }
        }

        class Obstacle {
            constructor() {
                this.x = width + 50;
                this.y = height - CONFIG.groundHeight - 40; 
                this.markedForDeletion = false; 
                this.pulse = 0;
                this.rot = 0;

                let rnd = Math.random();
                let droneProb = Math.min(0.8, 0.3 + (gameSpeed/100)); 
                
                // Check allowed types
                let allowed = CONFIG.settings.types;
                
                // Default fallback
                this.type = 'spike';

                // Try to spawn other types if allowed
                if (allowed.includes('demogorgon') && rnd > 0.85) this.type = 'demogorgon';
                else if (allowed.includes('demodog') && rnd > 0.6) this.type = 'demodog';
                else if (allowed.includes('drone') && rnd > 0.4) this.type = 'drone';

                // Setup dimensions based on type
                if (this.type === 'drone') {
                    this.y -= 50 + Math.random() * 120;
                    this.w = 50; this.h = 30; 
                    this.floatOffset = Math.random() * 100;
                } else if (this.type === 'demodog') {
                    this.y = height - CONFIG.groundHeight - 25; 
                    this.w = 60; this.h = 25; 
                } else if (this.type === 'demogorgon') {
                    this.y = height - CONFIG.groundHeight - 80;
                    this.w = 40; this.h = 80;
                } else {
                    this.w = 40 + Math.random() * 40; 
                    if (gameSpeed > 20 && Math.random() > 0.5) this.w += 40; 
                }
            }
            
            update() {
                this.x -= gameSpeed; 
                if (this.x + this.w < -100) this.markedForDeletion = true;
                this.pulse += 0.2; 
                
                if (this.type === 'drone') {
                    let jitter = gameSpeed > 30 ? Math.sin(frame * 0.5) * 2 : 0;
                    this.y += (Math.sin(this.floatOffset + frame * 0.1) * 1) + jitter;
                }
            }

            getHitbox() {
                if (this.type === 'drone') {
                    let visualY = this.y + 20;
                    let floatY = Math.sin(this.floatOffset + frame * 0.1) * 1;
                    return { x: this.x, y: visualY - 10 + floatY, w: this.w, h: 20 };
                } else if (this.type === 'demodog') {
                    return { x: this.x + 5, y: this.y + 5, w: this.w - 10, h: this.h - 5 };
                } else if (this.type === 'demogorgon') {
                    return { x: this.x + 10, y: this.y, w: this.w - 20, h: this.h };
                } else {
                    return { x: this.x + 10, y: this.y + 20, w: this.w - 20, h: 20 };
                }
            }
            
            draw() {
                let floatY = 0;
                if (this.type === 'drone') floatY = Math.sin(this.floatOffset + frame * 0.1) * 1;

                ctx.save(); ctx.translate(this.x + this.w/2, this.y + 20 + floatY); 
                
                if (currentTheme === 'dark') ctx.globalCompositeOperation = 'lighter';
                ctx.shadowBlur = currentTheme === 'dark' ? 15 : 0;
                ctx.shadowColor = CONFIG.colors.obstacle; 
                ctx.strokeStyle = CONFIG.colors.obstacle; ctx.lineWidth = 2;

                if (this.type === 'drone') {
                    // DEMOBAT SHAPE
                    if (currentTheme === 'light') { ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2; } 
                    else { ctx.fillStyle = '#000'; } 
                    
                    // Body
                    ctx.beginPath(); ctx.ellipse(0, 0, 10, 15, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    
                    // Wings
                    ctx.save(); 
                    // Flap wings
                    let flap = Math.sin(frame * 0.5) * 0.5;
                    ctx.scale(1, 1 + flap); 
                    ctx.beginPath();
                    ctx.moveTo(0, -5); ctx.lineTo(30, -20); ctx.lineTo(15, 0); // Right wing
                    ctx.moveTo(0, -5); ctx.lineTo(-30, -20); ctx.lineTo(-15, 0); // Left wing
                    ctx.stroke(); 
                    
                    // Wing fill
                    if (currentTheme === 'light') ctx.fillStyle = '#fff';
                    else ctx.fillStyle = 'rgba(20,0,0,0.8)';
                    ctx.fill();
                    
                    ctx.restore();
                    
                    // Eye/Mouth (No face, just red maw)
                    ctx.fillStyle = '#ff0000'; 
                    ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI*2); ctx.fill();

                } else if (this.type === 'demodog') {
                    // DEMODOG
                    ctx.translate(0, -10);
                    if (currentTheme === 'light') { ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2; } 
                    else { ctx.fillStyle = '#200'; }

                    ctx.beginPath(); ctx.rect(-25, 0, 50, 20); ctx.fill(); ctx.stroke();
                    let leg = Math.sin(frame * 0.8) * 10;
                    ctx.beginPath(); ctx.moveTo(-20, 20); ctx.lineTo(-25 - leg, 35); ctx.moveTo(20, 20); ctx.lineTo(25 + leg, 35); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(-30, 5); ctx.lineTo(-45, 0); ctx.lineTo(-45, 15); ctx.lineTo(-30, 10); ctx.fill(); ctx.stroke(); // Head
                    
                    if(currentTheme === 'light') ctx.fillStyle = '#000'; else ctx.fillStyle = '#fff';
                    ctx.fillRect(-45, 5, 5, 5); // Teeth

                } else if (this.type === 'demogorgon') {
                    // DEMOGORGON
                    ctx.translate(0, -40);
                    if (currentTheme === 'light') { ctx.strokeStyle = '#000'; ctx.lineWidth = 2; }
                    
                    ctx.beginPath(); ctx.moveTo(-10, 80); ctx.lineTo(0, 40); ctx.lineTo(10, 80); ctx.stroke(); // Legs
                    ctx.beginPath(); ctx.moveTo(0, 40); ctx.lineTo(0, 10); ctx.lineWidth=4; ctx.stroke(); ctx.lineWidth=2; // Body
                    ctx.beginPath(); ctx.moveTo(-20, 30); ctx.lineTo(0, 15); ctx.lineTo(20, 30); ctx.stroke(); // Arms
                    ctx.fillStyle = '#ff0000'; // Face
                    ctx.beginPath(); for(let i=0; i<5; i++) { let a = (i/5)*Math.PI*2; ctx.lineTo(Math.cos(a)*15, Math.sin(a)*15); ctx.lineTo(Math.cos(a + 0.3)*5, Math.sin(a + 0.3)*5); } ctx.closePath(); ctx.fill();
                } else {
                    // VINES / TENTACLES
                    if (currentTheme === 'light') {
                         ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
                    } else { ctx.fillStyle = '#220000'; } 

                    ctx.beginPath(); 
                    // Main vine mass
                    ctx.moveTo(-this.w/2, 20); 
                    ctx.bezierCurveTo(-this.w/4, -this.w * 1.5, this.w/4, -this.w, 0, -25);
                    ctx.bezierCurveTo(this.w/4, -this.w, this.w/2, 10, this.w/2, 20);
                    ctx.closePath(); ctx.fill(); ctx.stroke();
                    
                    if (currentTheme === 'dark') { ctx.strokeStyle = '#ffaaaa'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, 20); ctx.quadraticCurveTo(5, 0, 0, -20); ctx.stroke(); }
                }
                ctx.globalCompositeOperation = 'source-over'; ctx.restore();
            }
        }

        class Background {
            constructor() {
                this.mountains1 = []; this.mountains2 = []; this.gridOffset = 0;
                this.generateMountains(this.mountains1, 100, 150); this.generateMountains(this.mountains2, 50, 100);
            }
            generateMountains(arr, minH, maxH) {
                let currentW = width || 800; let x = 0;
                while(x < currentW * 2 || arr.length < 3) { 
                    let w = random(50, 150); let h = random(minH, maxH);
                    arr.push({x, w, h}); x += w - random(0, 20);
                }
            }
            update(slowMode = false) {
                let s = slowMode ? 2 : gameSpeed; this.gridOffset = (this.gridOffset - s) % 60;
                this.scrollLayer(this.mountains1, s * 0.1); this.scrollLayer(this.mountains2, s * 0.3);
            }
            scrollLayer(arr, speed) {
                if (!arr || arr.length === 0) return;
                arr.forEach(m => { m.x -= speed; });
                if (arr[0] && arr[0].x + arr[0].w < 0) {
                    let first = arr.shift();
                    let last = arr.length > 0 ? arr[arr.length-1] : first;
                    let startX = (last && !isNaN(last.x)) ? (last.x + last.w) : width;
                    first.x = startX - random(0, 50);
                    arr.push(first);
                }
            }
            draw() {
                let grad = ctx.createLinearGradient(0, 0, 0, height);
                // Dynamic Sky
                if (currentTheme === 'dark') {
                    grad.addColorStop(0, '#050000'); grad.addColorStop(0.5, '#220000'); grad.addColorStop(1, '#000'); // Red tint
                } else {
                    grad.addColorStop(0, '#ffffff'); grad.addColorStop(0.5, '#e0f7fa'); grad.addColorStop(1, '#87ceeb');
                }
                ctx.fillStyle = grad; ctx.fillRect(0, 0, width, height);

                ctx.save(); 
                let sunSize = Math.min(width, height) * 0.25; 
                let sunX = width / 2; 
                let horizonY = height - CONFIG.groundHeight;
                let sunY = horizonY - sunSize * 0.3; 
                
                let sunGrad = ctx.createLinearGradient(0, sunY - sunSize, 0, sunY + sunSize);
                sunGrad.addColorStop(0, CONFIG.colors.sunTop); sunGrad.addColorStop(1, CONFIG.colors.sunBot);
                
                // Sun Glow (Only Dark)
                if (currentTheme === 'dark') {
                    ctx.shadowBlur = 60; ctx.shadowColor = CONFIG.colors.sunBot; ctx.fillStyle = CONFIG.colors.sunBot;
                    ctx.beginPath(); ctx.arc(sunX, sunY, sunSize, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
                }

                // Sun Body + Stripes
                ctx.save();
                ctx.beginPath(); ctx.arc(sunX, sunY, sunSize, 0, Math.PI*2); ctx.clip();
                
                // Light mode sun glow effect
                if (currentTheme === 'light') ctx.globalCompositeOperation = 'source-over';
                else ctx.globalCompositeOperation = 'lighter';
                
                ctx.fillStyle = sunGrad; ctx.fill();
                ctx.fillStyle = CONFIG.colors.bg; // Use BG color for stripes to "cut out"
                
                // In light mode, stripes should be sky color
                if (currentTheme === 'light') ctx.fillStyle = 'rgba(255,255,255,0.4)'; 

                for(let i=0; i<10; i++) { 
                    let h = sunSize * 0.05 + i * (sunSize * 0.02); 
                    let y = sunY + (sunSize * 0.1) + i * (sunSize * 0.12); 
                    ctx.fillRect(sunX - sunSize, y, sunSize*2, h); 
                }
                ctx.restore(); 
                ctx.restore(); 

                // Draw Forest Silhouette (Mountains)
                ctx.fillStyle = CONFIG.colors.mountains1; this.mountains1.forEach(m => { 
                    // Draw jagged tree line instead of smooth triangles
                    ctx.beginPath(); 
                    ctx.moveTo(m.x, height - CONFIG.groundHeight); 
                    ctx.lineTo(m.x + m.w/2, height - CONFIG.groundHeight - m.h); 
                    ctx.lineTo(m.x + m.w, height - CONFIG.groundHeight); 
                    ctx.fill(); 
                });
                ctx.fillStyle = CONFIG.colors.mountains2; this.mountains2.forEach(m => { ctx.beginPath(); ctx.moveTo(m.x, height - CONFIG.groundHeight); ctx.lineTo(m.x + m.w/2, height - CONFIG.groundHeight - m.h); ctx.lineTo(m.x + m.w, height - CONFIG.groundHeight); ctx.fill(); });
                
                ctx.save(); 
                if (currentTheme === 'dark') ctx.globalCompositeOperation = 'lighter'; 
                ctx.shadowBlur = 10; ctx.shadowColor = CONFIG.colors.grid; ctx.strokeStyle = currentTheme === 'dark' ? 'rgba(255, 0, 0, 0.4)' : 'rgba(94, 23, 235, 0.2)'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(0, height - CONFIG.groundHeight); ctx.lineTo(width, height - CONFIG.groundHeight);
                for(let x = this.gridOffset; x < width; x += 60) { ctx.moveTo(x, height - CONFIG.groundHeight); let center = width/2; let dist = (x - center) / width; ctx.lineTo(x - dist * 400, height); }
                ctx.stroke(); ctx.restore();
            }
        }

        // --- GAME FUNCTIONS ---
        function resizeCanvas() {
            // --- CHANGE STARTS HERE ---
            // Cap the pixel ratio at 1.5 for performance
            const dpr = Math.min(window.devicePixelRatio || 1, 1.5); 
            // ---------------------------

            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);
            width = window.innerWidth; height = window.innerHeight;
            
            // 35% Horizon (perfect for mobile)
            CONFIG.groundHeight = Math.max(150, height * 0.35);
            if (player) { player.y = height - CONFIG.groundHeight - player.h; }
            if (bg) { bg.mountains1 = []; bg.mountains2 = []; bg.generateMountains(bg.mountains1, 100, 150); bg.generateMountains(bg.mountains2, 50, 100); }
        }
        
        function initGame() {
            player = new Player(); bg = new Background(); obstacles = []; particles = [];
            score = 0; gameSpeed = CONFIG.baseSpeed; frame = 0; shake = 0;
            keys = { up: false, down: false }; 
            touchStartY = 0;
            nextSpawnGap = 0;
            document.getElementById('hud-highscore').innerText = Math.floor(globalTopScore).toString().padStart(5, '0');
        }

        function spawnObstacle() {
            if (frame < 60) return; // Warmup

            let lastObs = obstacles[obstacles.length-1];
            
            // CHAOS ENGINE: Irregular Spacing logic
            if (!lastObs || (width - lastObs.x > nextSpawnGap)) {
                // Base gap decreases as speed increases
                let baseGap = (gameSpeed * CONFIG.settings.gapMult); 
                let variance = random(80, 500); 
                // Much tighter variance at high scores for "Impossible" feel
                if (score > 2000) variance = random(40, 300);

                nextSpawnGap = baseGap + variance;
                obstacles.push(new Obstacle());
            }
        }

        function checkCollision(pBox, oBox) {
            // Precise Hitbox
            return (pBox.x < oBox.x + oBox.w && 
                    pBox.x + pBox.w > oBox.x && 
                    pBox.y < oBox.y + oBox.h && 
                    pBox.y + pBox.h > oBox.y);
        }

        function update() {
            frame++;
            if (gameSpeed < CONFIG.settings.maxSpeed) gameSpeed += CONFIG.settings.accel;
            score += gameSpeed * 0.05;
            if (shake > 0) shake *= 0.9; if (shake < 0.5) shake = 0;
            bg.update(); player.update();
            if (keys.up) player.jump(); if (keys.down) player.dive();
            spawnObstacle();
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i]; obs.update();
                
                let pBox = player.getHitbox();
                let oBox = obs.getHitbox();
                
                if (player.visible && checkCollision(pBox, oBox)) {
                    shake = 25; sfx.playExplosion(); player.explode(); 
                    deathCause = obs.type;
                    endGame();
                    sfx.playCreelClock(); // Trigger clock on death
                }
                if (obs.markedForDeletion) obstacles.splice(i, 1);
            }
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }
            updateUI();
        }

        function draw() {
            ctx.save();
            if (shake > 0.5) ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
            bg.draw(); particles.forEach(p => p.draw()); obstacles.forEach(o => o.draw()); player.draw();
            ctx.restore();
        }

        function loop() {
            requestAnimationFrame(loop);
            if (gameActive && !isPaused) { update(); draw(); } 
            else if (!isPaused) {
                if (shake > 0 || particles.length > 0) {
                     if (shake > 0) shake *= 0.9;
                     for (let i = particles.length - 1; i >= 0; i--) { particles[i].update(); if (particles[i].life <= 0) particles.splice(i, 1); }
                     bg.update(true); draw();
                } else { bg.update(true); draw(); }
            }
        }

        function updateUI() { document.getElementById('score').innerText = Math.floor(score).toString().padStart(5, '0'); }

        // --- GLOBAL WINDOW BINDINGS ---
        window.toggleTheme = function() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            CONFIG.colors = THEMES[currentTheme];
            document.body.className = currentTheme === 'dark' ? 'dark-mode' : 'light-mode';
            if (!gameActive) {
                ctx.fillStyle = CONFIG.colors.bg;
                ctx.fillRect(0,0,width,height);
                bg.draw();
            }
        }

        window.togglePause = function() {
            if (!gameActive) return;
            isPaused = !isPaused;
            if (isPaused) document.getElementById('pause-screen').classList.remove('hidden');
            else document.getElementById('pause-screen').classList.add('hidden');
        }

        window.goToNameEntry = function() {
            sfx.init(); document.getElementById('start-screen').classList.add('hidden'); document.getElementById('name-entry-screen').classList.remove('hidden'); setTimeout(()=>document.getElementById('player-name-start').focus(),100);
        }
        window.completeStart = function() {
            const input = document.getElementById('player-name-start');
            if (input.value.trim() !== "") { currentPlayerName = input.value.trim(); document.getElementById('player-name-input').value = currentPlayerName; }
            document.getElementById('name-entry-screen').classList.add('hidden');
            // Show difficulty screen next
            document.getElementById('difficulty-screen').classList.remove('hidden');
        }
        
        window.startGame = function(diff) {
            currentDiff = diff;
            // Update config with difficulty settings
            CONFIG.settings = DIFFICULTY_SETTINGS[diff];
            
            sfx.init(); sfx.startMusic(); initGame(); gameActive = true; isPaused = false;
            // Force reset keys to prevent accidental jump on start
            keys.up = false; keys.down = false; 
            document.getElementById('difficulty-screen').classList.add('hidden'); 
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('new-record-ui').classList.add('hidden'); document.getElementById('restart-btn-container').classList.remove('hidden');
            document.getElementById('mission-log').classList.remove('visible'); document.getElementById('mission-log').innerText = '';
            const btn = document.getElementById('btn-analyze'); btn.style.display = 'inline-block'; btn.innerText = "ANALYZE BLACK BOX ✨"; btn.disabled = false;
            
            window.generatePilotIdentity(currentPlayerName);
        }
        
        window.resetGame = function() {
            refreshLeaderboard(); document.getElementById('game-over-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); initGame(); 
        }
        window.saveScoreAndRestart = function() {
            const name = document.getElementById('player-name-input').value.toUpperCase() || 'UNK';
            submitScoreOnline(name, score);
            window.resetGame();
        }
        
        async function submitScoreOnline(name, scoreVal) {
            if (scoreVal < 10) return;
            const final = Math.floor(scoreVal);
            if (!useLocalStorage && user && db) {
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                    await addDoc(col, { name: name, score: final, timestamp: Date.now(), uid: user.uid });
                    refreshLeaderboard();
                } catch (e) {
                    console.error("Submit failed, saving locally");
                    saveLocally(name, final);
                }
            } else {
                saveLocally(name, final);
                refreshLeaderboard();
            }
        }

        function endGame() {
            gameActive = false; sfx.stopMusic(); submitScoreOnline(currentPlayerName, score);
            const finalScore = Math.floor(score); const gap = finalScore - globalTopScore;
            const uiDiv = document.getElementById('score-comparison-text');
            if (gap >= 0) uiDiv.innerHTML = `<span style="color:#ffd700">NEW GLOBAL RECORD!</span> (+${gap})`; else uiDiv.innerHTML = `GAP TO #1: <span class="gap">${gap}m</span>`;
            setTimeout(() => document.getElementById('game-over-screen').classList.remove('hidden'), 1000);
        }

        // --- LEADERBOARD LOGIC ---
        async function refreshLeaderboard() {
            let scores = [];
            if (!useLocalStorage && user && db) {
                try {
                    const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => { const data = doc.data(); if (data.name && data.score) scores.push(data); });
                    const lbStatus = document.getElementById('lb-status');
                    if (lbStatus) lbStatus.innerText = "LIVE";
                } catch (e) { console.warn("Fetch fail, fallback"); return; }
            } else {
                scores = JSON.parse(localStorage.getItem('neon_runner_lb') || '[]');
                if (scores.length === 0) scores = [{name: 'CPU', score: 1000}, {name: 'NEO', score: 500}];
            }
            scores.sort((a, b) => b.score - a.score);
            globalTopScore = scores.length > 0 ? scores[0].score : 0;
            document.getElementById('hud-highscore').innerText = globalTopScore.toString().padStart(5, '0');
            const list = document.getElementById('leaderboard-list'); list.innerHTML = '';
            if (scores.length === 0) { list.innerHTML = '<div class="lb-row" style="justify-content: center;"><span>NO DATA</span></div>'; } 
            else { scores.slice(0, 5).forEach((s, index) => { const row = document.createElement('div'); row.className = 'lb-row'; row.innerHTML = `<span>${index+1}. ${s.name}</span><span>${s.score.toString().padStart(5, '0')}</span>`; list.appendChild(row); }); }
        }

        function saveLocally(name, scoreVal) {
            let scores = JSON.parse(localStorage.getItem('neon_runner_lb') || '[]');
            scores.push({name, score: scoreVal}); scores.sort((a, b) => b.score - a.score); scores = scores.slice(0, 10);
            localStorage.setItem('neon_runner_lb', JSON.stringify(scores));
        }

        // --- INPUTS ---
        window.addEventListener('keydown', e => {
            if (e.code === 'KeyP' || e.code === 'Escape') window.togglePause();
            if(e.code==='Space'||e.code==='ArrowUp'||e.code==='ArrowDown') {
                if (e.target.tagName !== 'INPUT') e.preventDefault();
            }
            if(e.code==='Space'||e.code==='ArrowUp') {
                if (e.target.tagName !== 'INPUT') keys.up = true;
            }
            if(e.code==='ArrowDown') keys.down = true;

            if(e.code==='Space' && !gameActive) {
                if (e.target.tagName === 'INPUT') return; 
                if(!document.getElementById('start-screen').classList.contains('hidden')) window.goToNameEntry();
                else if(!document.getElementById('game-over-screen').classList.contains('hidden') && document.getElementById('new-record-ui').classList.contains('hidden')) window.resetGame();
            }
            if(e.code==='Enter') {
                if(!document.getElementById('name-entry-screen').classList.contains('hidden')) window.completeStart();
                else if(!document.getElementById('new-record-ui').classList.contains('hidden')) window.saveScoreAndRestart();
            }
        });
        window.addEventListener('keyup', e => { if(e.code==='Space'||e.code==='ArrowUp') keys.up = false; if(e.code==='ArrowDown') keys.down = false; });
        
        window.addEventListener('touchstart', e => {
            if (!gameActive) return; 
            if (e.target.closest('.icon-btn')) return;
            e.preventDefault(); touchStartY = e.touches[0].clientY; keys.up = true; 
        }, {passive: false});
        window.addEventListener('touchmove', e => {
            if (!gameActive) return; e.preventDefault();
            if (e.touches[0].clientY - touchStartY > 50) { keys.up = false; keys.down = true; }
        }, {passive: false});
        window.addEventListener('touchend', () => { keys.up = false; keys.down = false; });
        
        window.addEventListener('mousedown', (e) => { 
            if (e.target.closest('.icon-btn')) return;
            if(gameActive) keys.up = true; 
        });
        window.addEventListener('mouseup', () => keys.up = false);
        window.addEventListener('resize', () => { 
            resizeCanvas();
            if (!gameActive) {
                ctx.fillStyle = CONFIG.colors.bg;
                ctx.fillRect(0,0,width,height);
                bg.draw(); // Redraw static BG
            }
        });

        // --- STARTUP ---
        resizeCanvas();
        // Initialize CONFIG.settings to easy by default to prevent undefined errors before game start
        CONFIG.settings = DIFFICULTY_SETTINGS.easy;
        initFirebase();
        initGame();
        loop();

    </script>
</body>

</html>


